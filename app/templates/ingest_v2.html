<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Data Ingestion Tool v2 - Video Scorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text y='50%' x='50%' text-anchor='middle' dominant-baseline='central' font-size='48'>üé¨</text></svg>">
  <link rel="stylesheet" href="/themes/{{ settings.style }}">
  <style>
    .ingest-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .ingest-header {
      margin-bottom: 30px;
    }

    .ingest-header h1 {
      margin: 0 0 10px 0;
    }

    .ingest-header p {
      margin: 0;
      opacity: 0.7;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      background: var(--accent-color, #4a90e2);
      color: white;
      border-radius: 12px;
      font-size: 0.8em;
      margin-left: 10px;
    }

    .badge.new {
      background: #28a745;
    }

    .workflow-steps {
      display: flex;
      justify-content: space-between;
      margin: 30px 0;
      padding: 20px;
      background: var(--bg-secondary, #2a2a2a);
      border-radius: 8px;
    }

    .workflow-step {
      flex: 1;
      text-align: center;
      padding: 0 10px;
      position: relative;
    }

    .workflow-step:not(:last-child)::after {
      content: '‚Üí';
      position: absolute;
      right: -15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.5em;
      color: var(--text-color, #fff);
      opacity: 0.5;
    }

    .step-number {
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
      background: var(--border-color, #444);
      color: var(--text-color, #fff);
      border-radius: 50%;
      margin-bottom: 10px;
    }

    .step-number.active {
      background: var(--accent-color, #4a90e2);
    }

    .step-number.completed {
      background: #28a745;
    }

    .step-title {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .step-description {
      font-size: 0.9em;
      opacity: 0.7;
    }

    .parameters-form {
      background: var(--bg-secondary, #2a2a2a);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .form-section {
      margin-bottom: 25px;
    }

    .form-section h3 {
      margin: 0 0 15px 0;
      color: var(--accent-color, #4a90e2);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color, #444);
      background: var(--bg-primary, #1a1a1a);
      color: var(--text-color, #fff);
      border-radius: 4px;
      box-sizing: border-box;
    }

    .form-group-inline {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group-inline input[type="text"] {
      flex: 1;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      margin: 0;
    }
    
    .file-type-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: #555;
      border: 2px solid #555;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      font-weight: 500;
      color: #999;
    }
    
    .file-type-toggle:hover {
      border-color: var(--accent-color, #4a90e2);
      background: #666;
    }
    
    .file-type-toggle.active {
      background: var(--accent-color, #4a90e2);
      border-color: var(--accent-color, #4a90e2);
      color: white;
      box-shadow: 0 0 15px rgba(74, 144, 226, 0.6), 0 0 30px rgba(74, 144, 226, 0.4);
    }
    
    .file-type-toggle input[type="checkbox"] {
      display: none;
    }
    
    .file-type-icon {
      display: none;
    }

    .browse-btn {
      padding: 8px 16px;
      background: var(--accent-color, #4a90e2);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }

    .browse-btn:hover {
      background: var(--accent-hover, #357abd);
    }

    .process-btn {
      padding: 12px 24px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 20px;
    }

    .process-btn:hover:not(:disabled) {
      background: #218838;
    }

    .process-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .progress-section {
      background: var(--bg-secondary, #2a2a2a);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .progress-section.show {
      display: block;
    }

    .progress-bar-container {
      width: 100%;
      height: 20px;
      background: var(--border-color, #444);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4a90e2, #28a745);
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .current-file {
      font-family: monospace;
      font-size: 0.9em;
      color: var(--accent-color, #4a90e2);
      margin: 5px 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .stat-card {
      background: var(--bg-primary, #1a1a1a);
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-number {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--accent-color, #4a90e2);
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.7;
      margin-top: 5px;
    }

    .preview-section {
      background: var(--bg-secondary, #2a2a2a);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .preview-section.show {
      display: block;
    }

    .preview-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent-color, #4a90e2);
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-secondary {
      background: var(--border-color, #444);
      color: var(--text-color, #fff);
    }

    .btn:hover:not(:disabled) {
      opacity: 0.9;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .commit-section {
      background: var(--bg-secondary, #2a2a2a);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .commit-section.show {
      display: block;
    }

    .error-list {
      background: #fff5f5;
      color: #c53030;
      border: 1px solid #fed7d7;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
    }

    .error-item {
      margin: 5px 0;
      font-family: monospace;
      font-size: 0.9em;
    }

    .success-message {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #9ae6b4;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
    }

    .nsfw-indicator {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .nsfw-indicator.available {
      background: #28a745;
      color: white;
    }

    .nsfw-indicator.unavailable {
      background: #ffc107;
      color: #212529;
    }

    /* Directory tree overlay */
    .directory-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .directory-overlay.active {
      display: flex;
    }

    .directory-panel {
      background: var(--bg-primary, #1a1a1a);
      border-radius: 8px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .directory-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color, #444);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .directory-header h2 {
      margin: 0;
    }

    .directory-close-btn {
      background: none;
      border: none;
      color: var(--text-color, #fff);
      font-size: 32px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .directory-close-btn:hover {
      color: #ff4444;
    }

    .directory-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .current-path {
      margin-bottom: 15px;
      padding: 10px;
      background: var(--bg-secondary, #2a2a2a);
      border-radius: 4px;
      font-family: monospace;
      word-break: break-all;
    }

    .directory-tree {
      font-family: monospace;
    }

    .tree-item {
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 4px;
      margin: 2px 0;
      position: relative;
    }

    .tree-item:hover {
      background: var(--bg-secondary, #2a2a2a);
    }

    .tree-item.selected {
      background: rgba(74, 144, 226, 0.3);
      border: 1px solid var(--accent-color, #4a90e2);
    }
    
    .tree-item-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tree-item-actions {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }
    
    .tree-add-btn,
    .tree-remove-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .tree-add-btn {
      background: #28a745;
      color: white;
    }
    
    .tree-add-btn:hover {
      background: #218838;
    }
    
    .tree-remove-btn {
      background: #dc3545;
      color: white;
    }
    
    .tree-remove-btn:hover {
      background: #c82333;
    }

    .tree-folder {
      font-weight: 500;
    }

    .tree-files {
      color: #888;
      font-size: 0.9em;
      margin-left: 20px;
    }

    .tree-caret {
      width: 0;
      height: 0;
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
      border-left: 7px solid var(--text-color, #fff);
      display: inline-block;
      margin-right: 5px;
      transition: transform 0.2s;
    }

    .tree-caret.expanded {
      transform: rotate(90deg);
    }

    .ingest-stats-pill {
      display: inline-block;
      background: rgba(74, 144, 226, 0.2);
      color: #4a90e2;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 500;
      margin-left: 8px;
      border: 1px solid rgba(74, 144, 226, 0.3);
    }

    .ingest-stats-pill.complete {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
      border-color: rgba(76, 175, 80, 0.3);
    }

    .ingest-stats-pill.partial {
      background: rgba(255, 152, 0, 0.2);
      color: #ff9800;
      border-color: rgba(255, 152, 0, 0.3);
    }

    .ingest-stats-pill.empty {
      background: rgba(158, 158, 158, 0.2);
      color: #9e9e9e;
      border-color: rgba(158, 158, 158, 0.3);
    }

    .tree-children {
      margin-left: 20px;
      display: none;
    }

    .tree-children.expanded {
      display: block;
    }

    .tree-nav-btn {
      padding: 8px 12px;
      background: var(--accent-color, #4a90e2);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
      margin-right: 8px;
    }

    .tree-nav-btn:hover {
      background: var(--accent-hover, #357abd);
    }
    
    .tree-nav-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .tree-sort-btn {
      padding: 8px 12px;
      background: var(--border-color, #444);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    
    .tree-sort-btn:hover {
      background: #555;
    }
    
    .tree-sort-btn.active {
      background: var(--accent-color, #4a90e2);
    }

    .tree-select-btn {
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
      width: 100%;
    }

    .tree-select-btn:hover {
      background: #218838;
    }
    
    .tree-clear-btn {
      padding: 10px 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }
    
    .tree-clear-btn:hover {
      background: #c82333;
    }
    
    .selected-directories {
      margin: 10px 0;
      padding: 10px;
      background: var(--bg-secondary, #2a2a2a);
      border-radius: 4px;
      border: 1px solid var(--border-color, #444);
    }
    
    .selected-directories h4 {
      margin: 0 0 10px 0;
      font-size: 0.9em;
      color: var(--accent-color, #4a90e2);
    }
    
    .selected-dir-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      margin: 4px 0;
      background: rgba(74, 144, 226, 0.1);
      border: 1px solid rgba(74, 144, 226, 0.3);
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85em;
    }
    
    .selected-dir-remove {
      padding: 2px 6px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .selected-dir-remove:hover {
      background: #c82333;
    }
    
    .selected-dirs-display {
      margin-bottom: 15px;
      padding: 15px;
      background: var(--bg-secondary, #2a2a2a);
      border-radius: 4px;
      border: 1px solid var(--border-color, #444);
    }
    
    .selected-dirs-display h4 {
      margin: 0 0 10px 0;
      color: var(--accent-color, #4a90e2);
    }
    
    .selected-dirs-list {
      max-height: 150px;
      overflow-y: auto;
    }
    
    .selected-dirs-list-item {
      padding: 6px 8px;
      margin: 4px 0;
      background: rgba(74, 144, 226, 0.1);
      border: 1px solid rgba(74, 144, 226, 0.3);
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85em;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .selected-dirs-list-item button {
      padding: 2px 6px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .selected-dirs-list-item button:hover {
      background: #c82333;
    }
    
    .no-directories-message {
      color: #888;
      font-style: italic;
      font-size: 0.9em;
    }

    /* Loading indicator */
    .directory-loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: var(--text-color, #fff);
    }

    .directory-loading.show {
      display: block;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color, #444);
      border-top: 4px solid var(--accent-color, #4a90e2);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .workflow-steps {
        flex-direction: column;
        gap: 20px;
      }

      .workflow-step:not(:last-child)::after {
        content: '‚Üì';
        position: static;
        display: block;
        margin: 10px 0;
      }

      .preview-actions {
        flex-direction: column;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      /* Fix width issues for directory and pattern inputs on mobile */
      .form-group-inline {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .form-group-inline input[type="text"] {
        width: 100%;
        min-width: 0;
      }

      .browse-btn {
        width: 100%;
        justify-content: center;
      }

      .form-group input[type="text"],
      .form-group input[type="number"],
      .form-group select {
        min-width: 0;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="ingest-container">
    <div class="ingest-header">
      <h1>üé¨ Data Ingestion Tool v2 <span class="badge new">Enhanced</span></h1>
      <p>Batch process media files with preview and commit workflow</p>
    </div>

    <!-- Workflow Steps -->
    <div class="workflow-steps">
      <div class="workflow-step">
        <div class="step-number active" id="step-1">1</div>
        <div class="step-title">Configure</div>
        <div class="step-description">Set parameters</div>
      </div>
      <div class="workflow-step">
        <div class="step-number" id="step-2">2</div>
        <div class="step-title">Process</div>
        <div class="step-description">Extract data</div>
      </div>
      <div class="workflow-step">
        <div class="step-number" id="step-3">3</div>
        <div class="step-title">Preview</div>
        <div class="step-description">Review results</div>
      </div>
      <div class="workflow-step">
        <div class="step-number" id="step-4">4</div>
        <div class="step-title">Commit</div>
        <div class="step-description">Save to database</div>
      </div>
    </div>

    <!-- Parameters Form -->
    <div class="parameters-form" id="parameters-form">
      <div class="form-section">
        <h3>üìÅ Source Directory</h3>
        <div class="form-group">
          <label for="directory">Directory Path (deprecated - use Browse to select multiple)</label>
          <div class="form-group-inline">
            <input type="text" id="directory" placeholder="/path/to/media/files" readonly style="display: none;" />
            <button type="button" class="browse-btn" onclick="openDirectoryBrowser()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 6h-2l-2-2H8L6 6H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
              </svg>
              Browse & Select Directories
            </button>
          </div>
        </div>
        <div id="selected-dirs-display" class="selected-dirs-display" style="display: none;">
          <h4>Selected Directories (<span id="selected-count">0</span>)</h4>
          <div id="selected-dirs-list" class="selected-dirs-list"></div>
        </div>
        <div class="form-group">
          <label>File Types</label>
          <div id="file-types-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px;">
            <div style="color: #888; font-style: italic; font-size: 0.9em;">Select directories first to see available file types</div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3>üîû NSFW Detection</h3>
        <div class="checkbox-group">
          <input type="checkbox" id="enable_nsfw_detection" checked />
          <label for="enable_nsfw_detection">Enable NSFW Detection</label>
          <span class="nsfw-indicator {{ 'available' if nsfw_detection_available else 'unavailable' }}">
            {{ 'Available' if nsfw_detection_available else 'Unavailable' }}
          </span>
        </div>
        <div class="form-group">
          <label for="nsfw_threshold">NSFW Threshold (0.0 - 1.0)</label>
          <input type="number" id="nsfw_threshold" value="0.5" min="0" max="1" step="0.1" />
        </div>
      </div>

      <div class="form-section">
        <h3>‚öôÔ∏è Processing Options</h3>
        <div class="checkbox-group">
          <input type="checkbox" id="extract_metadata" checked />
          <label for="extract_metadata">Extract Metadata (dimensions, duration, etc.)</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="extract_keywords" checked />
          <label for="extract_keywords">Extract Keywords from Metadata</label>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="import_scores" checked />
          <label for="import_scores">Import Existing Score Files</label>
        </div>
        <div class="form-group">
          <label for="max_files">Max Files to Process (for testing)</label>
          <input type="number" id="max_files" placeholder="Leave empty for all files" min="1" />
        </div>
      </div>

      <button type="button" class="process-btn" onclick="startProcessing()" id="process-btn">
        üöÄ Start Processing
      </button>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progress-section">
      <h3>‚è≥ Processing Files...</h3>
      <div class="progress-info">
        <span id="progress-text">Initializing...</span>
        <span id="progress-percentage">0%</span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      <div class="current-file" id="current-file"></div>
      
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="stat-processed">0</div>
          <div class="stat-label">Processed</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-metadata">0</div>
          <div class="stat-label">Metadata</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-keywords">0</div>
          <div class="stat-label">Keywords</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-scores">0</div>
          <div class="stat-label">Scores</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-nsfw">0</div>
          <div class="stat-label">NSFW Detected</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-errors">0</div>
          <div class="stat-label">Errors</div>
        </div>
      </div>

      <div id="error-container"></div>
    </div>

    <!-- Preview Section -->
    <div class="preview-section" id="preview-section">
      <h3>üìä Processing Completed!</h3>
      <p>Your files have been processed successfully. Review the results before committing to the database.</p>
      
      <div class="preview-actions">
        <a href="#" class="btn btn-primary" id="view-report-btn" target="_blank">
          üìÑ View Detailed Report
        </a>
        <button type="button" class="btn btn-success" onclick="commitToDatabase()" id="commit-btn">
          üíæ Commit to Database
        </button>
        <button type="button" class="btn btn-secondary" onclick="startNewSession()">
          üîÑ Start New Session
        </button>
      </div>
    </div>

    <!-- Commit Section -->
    <div class="commit-section" id="commit-section">
      <h3>üíæ Committing to Database...</h3>
      <div class="progress-info">
        <span id="commit-progress-text">Saving data...</span>
        <span id="commit-progress-percentage">0%</span>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="commit-progress-bar"></div>
      </div>
      
      <div id="commit-result"></div>
    </div>
  </div>

  <!-- Directory browser overlay -->
  <div class="directory-overlay" id="directory-overlay">
    <div class="directory-panel">
      <div class="directory-header">
        <h2>Select Directory</h2>
        <button class="directory-close-btn" id="directory-close-btn">√ó</button>
      </div>
      <div class="directory-content">
        <div class="tree-nav-controls">
          <button class="tree-nav-btn" id="parent-btn" style="display: none;">‚Üë Parent Directory</button>
          <button class="tree-sort-btn" id="sort-btn" title="Toggle sort order">
            <span id="sort-icon">‚¨á</span>
            <span id="sort-label">A-Z</span>
          </button>
        </div>
        <div class="current-path" id="current-path"></div>
        <div class="directory-loading" id="directory-loading">
          <div class="loading-spinner"></div>
          <div>Loading directories...</div>
        </div>
        <div id="selected-in-browser" class="selected-directories" style="display: none;">
          <h4>Selected Directories (<span id="browser-selected-count">0</span>)</h4>
          <div id="browser-selected-list"></div>
        </div>
        <div class="directory-tree" id="directory-tree"></div>
        <button class="tree-select-btn" id="add-current-btn">+ Add Current Directory</button>
        <button class="tree-clear-btn" id="clear-selection-btn">Clear All Selections</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let currentSessionId = null;
    let processingTimer = null;
    let commitTimer = null;
    let currentPath = '';
    let selectedDirectories = [];  // Array to store selected directories
    let sortOrder = 'asc';  // 'asc' for A-Z, 'desc' for Z-A
    let currentDirectoryData = null;  // Cache current directory data for re-sorting

    function updateWorkflowStep(stepNumber) {
      // Reset all steps
      for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById(`step-${i}`);
        stepEl.classList.remove('active', 'completed');
        if (i < stepNumber) {
          stepEl.classList.add('completed');
        } else if (i === stepNumber) {
          stepEl.classList.add('active');
        }
      }
    }

    function showSection(sectionId) {
      const sections = ['parameters-form', 'progress-section', 'preview-section', 'commit-section'];
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (id === sectionId) {
          el.classList.add('show');
          el.style.display = 'block';
        } else {
          el.classList.remove('show');
          el.style.display = 'none';
        }
      });
    }

    async function startProcessing() {
      // Build pattern from selected file type toggles
      const selectedTypes = [];
      document.querySelectorAll('.file-type-toggle.active').forEach(toggle => {
        selectedTypes.push('*.' + toggle.dataset.type);
      });
      
      if (selectedTypes.length === 0) {
        alert('Please select at least one file type');
        return;
      }
      
      const parameters = {
        directories: selectedDirectories.length > 0 ? selectedDirectories : null,
        directory: null,  // Deprecated
        pattern: selectedTypes.join('|'),
        enable_nsfw_detection: document.getElementById('enable_nsfw_detection').checked,
        nsfw_threshold: parseFloat(document.getElementById('nsfw_threshold').value),
        extract_metadata: document.getElementById('extract_metadata').checked,
        extract_keywords: document.getElementById('extract_keywords').checked,
        import_scores: document.getElementById('import_scores').checked,
        max_files: document.getElementById('max_files').value ? parseInt(document.getElementById('max_files').value) : null
      };

      if (!parameters.directories || parameters.directories.length === 0) {
        alert('Please select at least one directory using the Browse button');
        return;
      }

      try {
        document.getElementById('process-btn').disabled = true;
        document.getElementById('process-btn').textContent = 'üöÄ Starting...';

        const response = await fetch('/api/ingest/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ parameters })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to start processing');
        }

        const result = await response.json();
        currentSessionId = result.session_id;

        updateWorkflowStep(2);
        showSection('progress-section');
        
        // Start polling for progress
        startProgressPolling();

      } catch (error) {
        alert(`Error: ${error.message}`);
        document.getElementById('process-btn').disabled = false;
        document.getElementById('process-btn').textContent = 'üöÄ Start Processing';
      }
    }

    function startProgressPolling() {
      processingTimer = setInterval(async () => {
        try {
          const response = await fetch(`/api/ingest/status/${currentSessionId}`);
          if (!response.ok) {
            throw new Error('Failed to get status');
          }

          const status = await response.json();
          updateProgressDisplay(status);

          if (status.status === 'completed') {
            clearInterval(processingTimer);
            showPreviewSection();
          } else if (status.status === 'error') {
            clearInterval(processingTimer);
            showError(`Processing failed: ${status.error || 'Unknown error'}`);
          }

        } catch (error) {
          console.error('Error polling status:', error);
        }
      }, 1000);
    }

    function updateProgressDisplay(status) {
      console.log('Status update:', status); // Debug logging
      
      document.getElementById('progress-text').textContent = 
        `Processing ${status.processed_files}/${status.total_files} files`;
      document.getElementById('progress-percentage').textContent = `${status.progress}%`;
      document.getElementById('progress-bar').style.width = `${status.progress}%`;
      
      if (status.current_file) {
        document.getElementById('current-file').textContent = `Current: ${status.current_file}`;
      }

      // Update stats
      const stats = status.stats;
      console.log('Stats:', stats); // Debug logging
      document.getElementById('stat-processed').textContent = stats.processed_files;
      document.getElementById('stat-metadata').textContent = stats.metadata_extracted;
      document.getElementById('stat-keywords').textContent = stats.keywords_added;
      document.getElementById('stat-scores').textContent = stats.scores_imported;
      document.getElementById('stat-nsfw').textContent = stats.nsfw_detected;
      document.getElementById('stat-errors').textContent = stats.errors;

      // Show errors if any
      if (status.errors && status.errors.length > 0) {
        showErrors(status.errors);
      }
    }

    function showErrors(errors) {
      const container = document.getElementById('error-container');
      container.innerHTML = `
        <div class="error-list">
          <h4>Recent Errors:</h4>
          ${errors.map(error => `<div class="error-item">${error}</div>`).join('')}
        </div>
      `;
    }

    function showPreviewSection() {
      updateWorkflowStep(3);
      showSection('preview-section');
      
      // Set up report link
      const reportBtn = document.getElementById('view-report-btn');
      reportBtn.href = `/api/ingest/report/${currentSessionId}`;
    }

    async function commitToDatabase() {
      try {
        document.getElementById('commit-btn').disabled = true;
        document.getElementById('commit-btn').textContent = 'üíæ Starting Commit...';

        const response = await fetch('/api/ingest/commit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: currentSessionId })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to start commit');
        }

        updateWorkflowStep(4);
        showSection('commit-section');
        
        // Start polling for commit progress
        startCommitPolling();

      } catch (error) {
        alert(`Error: ${error.message}`);
        document.getElementById('commit-btn').disabled = false;
        document.getElementById('commit-btn').textContent = 'üíæ Commit to Database';
      }
    }

    function startCommitPolling() {
      commitTimer = setInterval(async () => {
        try {
          const response = await fetch(`/api/ingest/commit-status/${currentSessionId}`);
          if (!response.ok) {
            throw new Error('Failed to get commit status');
          }

          const status = await response.json();
          updateCommitDisplay(status);

          if (status.status === 'committed') {
            clearInterval(commitTimer);
            showCommitSuccess();
          } else if (status.status === 'commit_error') {
            clearInterval(commitTimer);
            showCommitError(status.commit_error || 'Unknown error');
          }

        } catch (error) {
          console.error('Error polling commit status:', error);
        }
      }, 1000);
    }

    function updateCommitDisplay(status) {
      document.getElementById('commit-progress-text').textContent = 'Saving to database...';
      document.getElementById('commit-progress-percentage').textContent = `${status.commit_progress}%`;
      document.getElementById('commit-progress-bar').style.width = `${status.commit_progress}%`;

      if (status.commit_errors && status.commit_errors.length > 0) {
        const container = document.getElementById('commit-result');
        container.innerHTML = `
          <div class="error-list">
            <h4>Commit Errors:</h4>
            ${status.commit_errors.map(error => `<div class="error-item">${error}</div>`).join('')}
          </div>
        `;
      }
    }

    function showCommitSuccess() {
      const container = document.getElementById('commit-result');
      container.innerHTML = `
        <div class="success-message">
          <h4>‚úÖ Successfully Committed to Database!</h4>
          <p>All processed data has been saved to your database. You can now view the files in the main application.</p>
          <p><em>This notice will persist until you clear it or start a new session.</em></p>
          <button type="button" class="btn btn-primary" onclick="window.location.href='/'">
            üè† Return to Main App
          </button>
          <button type="button" class="btn btn-secondary" onclick="startNewSession()">
            üîÑ Process More Files
          </button>
          <button type="button" class="btn btn-secondary" onclick="clearSessionNotice()">
            ‚ùå Clear Notice
          </button>
        </div>
      `;
    }

    function showCommitError(error) {
      const container = document.getElementById('commit-result');
      container.innerHTML = `
        <div class="error-list">
          <h4>‚ùå Commit Failed</h4>
          <p>Error: ${error}</p>
          <p><em>This error notice will persist until you clear it or start a new session.</em></p>
          <button type="button" class="btn btn-secondary" onclick="startNewSession()">
            üîÑ Start Over
          </button>
          <button type="button" class="btn btn-secondary" onclick="clearSessionNotice()">
            ‚ùå Clear Notice
          </button>
        </div>
      `;
    }

    function showError(message) {
      const container = document.getElementById('error-container');
      container.innerHTML = `
        <div class="error-list">
          <h4>‚ùå Processing Error</h4>
          <div class="error-item">${message}</div>
          <button type="button" class="btn btn-secondary" onclick="startNewSession()">
            üîÑ Start Over
          </button>
        </div>
      `;
    }

    function clearSessionNotice() {
      // Clean up current session without resetting the form
      if (currentSessionId) {
        fetch(`/api/ingest/session/${currentSessionId}`, { method: 'DELETE' })
          .then(() => {
            console.log('Session cleared');
            // Reset to initial state
            currentSessionId = null;
            updateWorkflowStep(1);
            showSection('parameters-form');
            
            // Reset buttons (with null checks)
            const processBtn = document.getElementById('process-btn');
            if (processBtn) {
              processBtn.disabled = false;
              processBtn.textContent = 'üöÄ Start Processing';
            }
            const commitBtn = document.getElementById('commit-btn');
            if (commitBtn) {
              commitBtn.disabled = false;
              commitBtn.textContent = 'üíæ Commit to Database';
            }
            
            // Clear progress bars (with null checks)
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) progressBar.style.width = '0%';
            
            const commitProgressBar = document.getElementById('commit-progress-bar');
            if (commitProgressBar) commitProgressBar.style.width = '0%';
            
            const errorContainer = document.getElementById('error-container');
            if (errorContainer) errorContainer.innerHTML = '';
            
            const commitResult = document.getElementById('commit-result');
            if (commitResult) commitResult.innerHTML = '';
          })
          .catch(err => {
            console.error('Failed to clear session:', err);
            alert('Failed to clear session. Please try again.');
          });
      }
    }

    function startNewSession() {
      // Clean up current session
      if (currentSessionId) {
        fetch(`/api/ingest/session/${currentSessionId}`, { method: 'DELETE' });
      }
      
      // Clear timers
      if (processingTimer) {
        clearInterval(processingTimer);
        processingTimer = null;
      }
      if (commitTimer) {
        clearInterval(commitTimer);
        commitTimer = null;
      }
      
      // Reset UI
      currentSessionId = null;
      updateWorkflowStep(1);
      showSection('parameters-form');
      
      // Reset form
      document.getElementById('process-btn').disabled = false;
      document.getElementById('process-btn').textContent = 'üöÄ Start Processing';
      document.getElementById('commit-btn').disabled = false;
      document.getElementById('commit-btn').textContent = 'üíæ Commit to Database';
      
      // Clear progress
      document.getElementById('progress-bar').style.width = '0%';
      document.getElementById('commit-progress-bar').style.width = '0%';
      document.getElementById('error-container').innerHTML = '';
      document.getElementById('commit-result').innerHTML = '';
    }
    
    // Helper functions for managing selected directories
    function addDirectory(path) {
      if (!selectedDirectories.includes(path)) {
        selectedDirectories.push(path);
        updateSelectedDirectoriesDisplay();
        updateBrowserSelectedDisplay();
        updateFileTypes();  // Update available file types
        updateTreeItemState(path, true);  // Update tree item appearance
      }
    }
    
    function removeDirectory(path) {
      selectedDirectories = selectedDirectories.filter(d => d !== path);
      updateSelectedDirectoriesDisplay();
      updateBrowserSelectedDisplay();
      updateFileTypes();  // Update available file types
      updateTreeItemState(path, false);  // Update tree item appearance
    }
    
    function clearAllDirectories() {
      selectedDirectories = [];
      updateSelectedDirectoriesDisplay();
      updateBrowserSelectedDisplay();
      updateFileTypes();  // Update available file types
    }
    
    function isDirectorySelected(path) {
      return selectedDirectories.includes(path);
    }
    
    // Toggle sort order and re-render the directory tree
    function toggleSortOrder() {
      sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
      
      // Update button appearance
      const sortBtn = document.getElementById('sort-btn');
      const sortIcon = document.getElementById('sort-icon');
      const sortLabel = document.getElementById('sort-label');
      
      if (sortOrder === 'asc') {
        sortIcon.textContent = '‚¨á';
        sortLabel.textContent = 'A-Z';
      } else {
        sortIcon.textContent = '‚¨Ü';
        sortLabel.textContent = 'Z-A';
      }
      
      // Re-render the current directory with new sort order
      if (currentDirectoryData) {
        renderDirectoryTree(currentDirectoryData);
      }
    }
    
    // Update the visual state of a tree item
    function updateTreeItemState(path, selected) {
      // Find all tree items with this path
      const directoryTree = document.getElementById('directory-tree');
      const treeItems = directoryTree.querySelectorAll('.tree-item');
      
      treeItems.forEach(item => {
        const actions = item.querySelector('.tree-item-actions');
        if (!actions) return;
        
        // Check if this is the item we're looking for by finding the button with this path
        const addBtn = actions.querySelector(`.tree-add-btn[onclick*="${path.replace(/'/g, "\\'")}"]`);
        const removeBtn = actions.querySelector(`.tree-remove-btn[onclick*="${path.replace(/'/g, "\\'")}"]`);
        
        if (addBtn || removeBtn) {
          // This is the item we're looking for
          if (selected) {
            // Change to selected state
            item.classList.add('selected');
            actions.innerHTML = `<button class="tree-remove-btn" onclick="event.stopPropagation(); removeDirectory('${path.replace(/'/g, "\\'")}')">‚àí</button>`;
          } else {
            // Change to unselected state
            item.classList.remove('selected');
            actions.innerHTML = `<button class="tree-add-btn" onclick="event.stopPropagation(); addDirectory('${path.replace(/'/g, "\\'")}')">+</button>`;
          }
        }
      });
    }
    
    // Update available file types based on selected directories
    async function updateFileTypes() {
      const container = document.getElementById('file-types-container');
      
      if (selectedDirectories.length === 0) {
        container.innerHTML = '<div style="color: #888; font-style: italic; font-size: 0.9em;">Select directories first to see available file types</div>';
        return;
      }
      
      try {
        const response = await fetch('/api/ingest/file-types', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(selectedDirectories)
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch file types');
        }
        
        const data = await response.json();
        const fileTypes = data.file_types;
        
        if (fileTypes.length === 0) {
          container.innerHTML = '<div style="color: #888; font-style: italic; font-size: 0.9em;">No supported file types found in selected directories</div>';
          return;
        }
        
        // Create toggle buttons for each file type
        container.innerHTML = fileTypes.map(type => {
          return `
            <label class="file-type-toggle active" data-type="${type}">
              <input type="checkbox" checked />
              <span>.${type}</span>
            </label>
          `;
        }).join('');
        
        // Add click handlers for toggles
        container.querySelectorAll('.file-type-toggle').forEach(toggle => {
          toggle.addEventListener('click', function() {
            this.classList.toggle('active');
            const checkbox = this.querySelector('input[type="checkbox"]');
            checkbox.checked = this.classList.contains('active');
          });
        });
      } catch (error) {
        console.error('Error fetching file types:', error);
        container.innerHTML = '<div style="color: #ff4444; font-size: 0.9em;">Error loading file types</div>';
      }
    }
    
    function updateSelectedDirectoriesDisplay() {
      const display = document.getElementById('selected-dirs-display');
      const list = document.getElementById('selected-dirs-list');
      const count = document.getElementById('selected-count');
      
      if (selectedDirectories.length === 0) {
        display.style.display = 'none';
        return;
      }
      
      display.style.display = 'block';
      count.textContent = selectedDirectories.length;
      
      list.innerHTML = selectedDirectories.map(dir => `
        <div class="selected-dirs-list-item">
          <span>üìÅ ${dir}</span>
          <button onclick="removeDirectory('${dir.replace(/'/g, "\\'")}')">√ó</button>
        </div>
      `).join('');
    }
    
    function updateBrowserSelectedDisplay() {
      const display = document.getElementById('selected-in-browser');
      const list = document.getElementById('browser-selected-list');
      const count = document.getElementById('browser-selected-count');
      
      if (selectedDirectories.length === 0) {
        display.style.display = 'none';
        return;
      }
      
      display.style.display = 'block';
      count.textContent = selectedDirectories.length;
      
      list.innerHTML = selectedDirectories.map(dir => `
        <div class="selected-dir-item">
          <span>üìÅ ${dir}</span>
          <button class="selected-dir-remove" onclick="removeDirectory('${dir.replace(/'/g, "\\'")}')">√ó</button>
        </div>
      `).join('');
    }

    function openDirectoryBrowser() {
      // Get directory browser elements
      const directoryOverlay = document.getElementById('directory-overlay');
      const directoryCloseBtn = document.getElementById('directory-close-btn');
      const currentPathDiv = document.getElementById('current-path');
      const directoryTree = document.getElementById('directory-tree');
      const addCurrentBtn = document.getElementById('add-current-btn');
      const clearSelectionBtn = document.getElementById('clear-selection-btn');
      const parentBtn = document.getElementById('parent-btn');
      const sortBtn = document.getElementById('sort-btn');
      
      // Set up event listeners if not already set
      if (!directoryOverlay.dataset.initialized) {
        // Close directory browser
        directoryCloseBtn.addEventListener('click', () => {
          directoryOverlay.classList.remove('active');
        });

        // Close overlay when clicking outside
        directoryOverlay.addEventListener('click', (e) => {
          if (e.target === directoryOverlay) {
            directoryOverlay.classList.remove('active');
          }
        });

        // Add current directory
        addCurrentBtn.addEventListener('click', () => {
          addDirectory(currentPath);
        });
        
        // Clear all selections
        clearSelectionBtn.addEventListener('click', () => {
          clearAllDirectories();
        });

        // Navigate to parent
        parentBtn.addEventListener('click', () => {
          const timestamp = new Date().getTime();
          fetch(`/api/ingest/directories?path=${encodeURIComponent(currentPath)}&_t=${timestamp}`)
            .then(res => res.json())
            .then(data => {
              if (data.parent) {
                loadDirectory(data.parent);
              }
            });
        });
        
        // Toggle sort order
        sortBtn.addEventListener('click', () => {
          toggleSortOrder();
        });
        
        directoryOverlay.dataset.initialized = 'true';
      }
      
      // Open the browser with current directory or empty
      // Force reload directory to refresh ingestion stats
      loadDirectory(currentPath || '');
      directoryOverlay.classList.add('active');
    }

    // Load directory contents
    async function loadDirectory(path) {
      const currentPathDiv = document.getElementById('current-path');
      const directoryTree = document.getElementById('directory-tree');
      const parentBtn = document.getElementById('parent-btn');
      const loadingIndicator = document.getElementById('directory-loading');
      
      try {
        // Show loading indicator
        loadingIndicator.classList.add('show');
        directoryTree.style.display = 'none';
        
        // Add timestamp to prevent caching and ensure fresh stats
        const timestamp = new Date().getTime();
        const res = await fetch(`/api/ingest/directories?path=${encodeURIComponent(path)}&_t=${timestamp}`);
        const data = await res.json();
        
        currentPath = data.path;
        currentPathDiv.textContent = data.path;
        
        // Show/hide parent button
        if (data.parent) {
          parentBtn.style.display = 'block';
        } else {
          parentBtn.style.display = 'none';
        }
        
        // Cache the data and render
        currentDirectoryData = data;
        renderDirectoryTree(data);
        
        // Update browser selected display
        updateBrowserSelectedDisplay();
        
        // Hide loading indicator and show tree
        loadingIndicator.classList.remove('show');
        directoryTree.style.display = 'block';
      } catch (err) {
        // Hide loading indicator on error
        loadingIndicator.classList.remove('show');
        directoryTree.style.display = 'block';
        directoryTree.innerHTML = `<div style="color: #ff4444; padding: 10px;">Error: ${err.message}</div>`;
      }
    }
    
    // Render directory tree with current sort order
    function renderDirectoryTree(data) {
      const directoryTree = document.getElementById('directory-tree');
      directoryTree.innerHTML = '';
      
      if (data.directories.length === 0 && data.file_summary === 'No files') {
        directoryTree.innerHTML = '<div style="color: #888; padding: 10px;">Empty directory</div>';
        return;
      }
      
      // Show file summary
      if (data.file_summary && data.file_summary !== 'No files') {
        const filesDiv = document.createElement('div');
        filesDiv.className = 'tree-files';
        filesDiv.textContent = `üìÑ ${data.file_summary}`;
        directoryTree.appendChild(filesDiv);
      }
      
      // Sort directories based on current sort order
      const sortedDirectories = [...data.directories].sort((a, b) => {
        if (sortOrder === 'asc') {
          return a.name.localeCompare(b.name, undefined, { sensitivity: 'base' });
        } else {
          return b.name.localeCompare(a.name, undefined, { sensitivity: 'base' });
        }
      });
      
      // Show subdirectories
      sortedDirectories.forEach(dir => {
        const item = document.createElement('div');
        item.className = 'tree-item';
        
        // Check if this directory is selected
        const selected = isDirectorySelected(dir.path);
        if (selected) {
          item.classList.add('selected');
        }
        
        // Determine pill class based on ingestion status
        let pillClass = 'empty';
        let pillText = '(0/0)';
        let pillHtml = '';
        
        if (dir.total_files > 0) {
          const ingested = dir.ingested_files || 0;
          const total = dir.total_files;
          pillText = `(${ingested}/${total})`;
          
          if (ingested === 0) {
            pillClass = 'empty';
          } else if (ingested >= total) {
            pillClass = 'complete';
          } else {
            pillClass = 'partial';
          }
          pillHtml = `<span class="ingest-stats-pill ${pillClass}">${pillText}</span>`;
        }
        
        // Create item content
        const contentHtml = `
          <div class="tree-item-content" onclick="loadDirectory('${dir.path.replace(/'/g, "\\'")}')">
            ${dir.has_children ? '<span class="tree-caret"></span>' : '<span style="width: 12px; display: inline-block;"></span>'}
            üìÅ ${dir.name}
            ${pillHtml}
          </div>
          <div class="tree-item-actions">
            ${selected 
              ? `<button class="tree-remove-btn" onclick="event.stopPropagation(); removeDirectory('${dir.path.replace(/'/g, "\\'")}')">‚àí</button>`
              : `<button class="tree-add-btn" onclick="event.stopPropagation(); addDirectory('${dir.path.replace(/'/g, "\\'")}')">+</button>`
            }
          </div>
        `;
        
        item.innerHTML = contentHtml;
        directoryTree.appendChild(item);
      });
    }

    // Check for active session on page load
    async function checkForActiveSession() {
      try {
        const response = await fetch('/api/ingest/active-session');
        if (!response.ok) return;
        
        const data = await response.json();
        if (data.session_id && data.status) {
          console.log('Found active session:', data.session_id, 'Status:', data.status);
          currentSessionId = data.session_id;
          
          // Restore appropriate view based on status
          if (data.status === 'processing' || data.status === 'starting') {
            updateWorkflowStep(2);
            showSection('progress-section');
            startProgressPolling();
          } else if (data.status === 'completed') {
            updateWorkflowStep(3);
            showSection('preview-section');
            // Update preview button with session ID
            const viewReportBtn = document.getElementById('view-report-btn');
            viewReportBtn.href = `/api/ingest/report/${currentSessionId}`;
          } else if (data.status === 'committing') {
            // Restore commit in-progress state
            updateWorkflowStep(4);
            showSection('commit-section');
            
            // Fetch current commit status to restore progress
            const statusResponse = await fetch(`/api/ingest/commit-status/${currentSessionId}`);
            if (statusResponse.ok) {
              const status = await statusResponse.json();
              updateCommitDisplay(status);
            }
            
            // Start polling for commit progress
            startCommitPolling();
          } else if (data.status === 'committed') {
            // Show success message that persists
            updateWorkflowStep(4);
            showSection('commit-section');
            
            // Fetch final commit status to show any errors
            const statusResponse = await fetch(`/api/ingest/commit-status/${currentSessionId}`);
            if (statusResponse.ok) {
              const status = await statusResponse.json();
              // Update progress bar to 100% (with null checks)
              const progressPercentage = document.getElementById('commit-progress-percentage');
              if (progressPercentage) progressPercentage.textContent = '100%';
              
              const progressBar = document.getElementById('commit-progress-bar');
              if (progressBar) progressBar.style.width = '100%';
              
              const progressText = document.getElementById('commit-progress-text');
              if (progressText) progressText.textContent = 'Commit completed';
            }
            
            // Show success message
            showCommitSuccess();
          } else if (data.status === 'commit_error') {
            // Show error message that persists
            updateWorkflowStep(4);
            showSection('commit-section');
            
            // Fetch commit error details
            const statusResponse = await fetch(`/api/ingest/commit-status/${currentSessionId}`);
            if (statusResponse.ok) {
              const status = await statusResponse.json();
              const errorMsg = status.commit_error || 'Unknown error occurred during commit';
              showCommitError(errorMsg);
            } else {
              showCommitError('Unknown error occurred during commit');
            }
          }
        }
      } catch (error) {
        console.error('Error checking for active session:', error);
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      updateWorkflowStep(1);
      showSection('parameters-form');
      
      // Initialize selected directories display
      updateSelectedDirectoriesDisplay();
      
      // Check if there's an active session to restore
      checkForActiveSession();
    });
  </script>
</body>
</html>